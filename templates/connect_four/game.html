{% extends "pages/page.html" %}
{% load connect_four_tags dajaxice_templatetags i18n staticfiles %}
{% block extra_js %}
<script type="text/javascript"
        src="{{ STATIC_URL }}connect_four/js/jquery-1.9.1.min.js"></script>
{% dajaxice_js_import %}
{% if not game.over %}
<script type="text/javascript">
function chip_over() {
    connect_four.get_chip_column($(this))
        .filter('.free')
        .addClass('highlighted')
        .first()
        .addClass('last');
}

function chip_out() {
    connect_four.get_chip_column($(this)).removeClass('highlighted last');
}

function cb_chip_click(data) {
    var move = data.move,
            victory = data.victory;
    if (move) {
        var $chip = connect_four.get_chip(data.move.row, data.move.col);
        connect_four.claim($chip, 2);
    }
    if (victory) {
        connect_four.victory(victory);
    }
}

function chip_click() {
    var $chip = $(this),
        $free_chip = connect_four.get_chip_column($chip).filter('.free').first();
    if ($free_chip.length) {
        connect_four.claim($free_chip, 1);
    }
}

function ConnectFour() {
    this.over = {{ game.over|yesno:"true,false" }};
    this.pk = {{ game.pk }};
}
ConnectFour.prototype.init = function () {
    this.chips = $('div.chip');
    this.chips
        .hover(chip_over, chip_out)
        .on('click', chip_click);
}
ConnectFour.prototype.get_chip = function (row, col) {
    return this.chips.filter('.row' + row + '.col' + col);
}
ConnectFour.prototype.get_chip_column = function ($chip) {
    return this.chips.filter('.col' + $chip.data('col'));
}
ConnectFour.prototype.victory = function (victory) {
    this.over = true;
    alert(victory.player + ' won in lines: ' + victory.lines);
    this.chips.off('mouseenter mouseleave');
    $('p.msg').html('{% blocktrans %}' +
        ' This game has ended. Please, start a new one ' +
        '<a href = "{{ new_game_url }}">here</a>. {% endblocktrans %}');
};
ConnectFour.prototype.claim = function ($chip, player) {
    if (this.over || !$chip.length) {
        return;
    }
    $chip.addClass('player' + player);
    $chip.removeClass('free');
    if (player === 1) {
        Dajaxice.connect_four.claim(
            cb_chip_click,
            {row: $chip.data('row'), col: $chip.data('col')}
        );
    }
};

var connect_four = new ConnectFour();

$(document).ready(function () {
    connect_four.init();
});
</script>
{% endif%}
{% endblock %}

{% block extra_css %}
<style>
div.board {
    width: {{ game.width_in_pixels }}px;
    height: {{ game.height_in_pixels }}px;
    position: relative;
    border: thin solid black;
}
div.chip {
    position: absolute;
    width: {{ CHIP_WIDTH }}px;
    height: {{ CHIP_HEIGHT }}px;
    background-image: url("{{ STATIC_URL }}connect_four/img/chip.png");
}
div.chip.highlighted.free {
{#    border: thick dotted black;#}
    background-image: url("{{ STATIC_URL }}connect_four/img/chip.png"), url("{% static 'connect_four/img/vertical_line.png' %}");
}
div.chip.highlighted.free.last {
    background-image: url("{{ STATIC_URL }}connect_four/img/chip.png"), url("{% static 'connect_four/img/vertical_arrow.png' %}");
}
div.chip.player1 {
    background-color: khaki;
}
div.chip.player2 {
    background-color: brown;
}
</style>
{% endblock %}

{% block main %}
{% if game %}
<div id="board" class="board">
{% for row in game.get_state %}
    {% for chip in row %}
        <div
            id="{{ chip.id }}"
            class="chip row{{ chip.row }} col{{ chip.col }}{{ chip.player_class }}"
            style="margin-left: {{ chip.margin_left }}px;
                   margin-top: {{ chip.margin_top }}px;"
            data-row="{{ chip.row }}" data-col="{{ chip.col }}"
            >
        </div>
    {% endfor %}
{% endfor %}
</div>

<p class="msg">
{% if game.over %}
{% blocktrans %}
    This game has ended.
    Please, start a new one <a href="{{ new_game_url }}">here</a>.
{% endblocktrans %}
{% endif %}
</p>

{% else %}
{% blocktrans %}
    You don't have any game pending at the moment.
    Please, start a new one <a href="{{ new_game_url }}">here</a>.
{% endblocktrans %}
{% endif %}
{% endblock %}
